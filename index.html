<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Zork Clone</title>
		<style type="text/css">
			.clickableLI {
				cursor: pointer;
			}
		</style>
	</head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	
	<body onload="setUp()">
		<p id="locationInfo"></p>
		<strong><p id="info" style="color: red"></p></strong>
		<p>Nearby Locations:</p>
		<ul id="nearbyLocations"></ul>
		<p>Nearby Items:</p>
		<ul id="nearbyItems"></ul>
		<p>Inventory:</p>
		<ul id="inventoryInfo"></ul>
		<p>Injuries:</p>
		<p id="healthStatusInfo"></p>
		
		<script>
			function getWeaponFromInventory(source)
			{
				this.type = "";
				this.rank = -1;
				this.name = "";
				for (let i = 0; i < source.length; i++)
				{
					var item = source[i];
					for (let j = 0; j < item.attributes.length; j++)
					{
						var attribute = item.attributes[j];
						if ((attribute.length > 6) && (attribute.substr(0,6) == "Weapon"))
						{
							testRank = parseInt(attribute.substr(7,8));
							if (testRank > this.rank)
							{
								this.name = item.name;
								this.type = attribute.substr(10,attribute.length);
								this.rank = testRank;
							}
							
						}
					}
				}
			}
			
			function item(name, actions, attributes)
			{
				this.name = name;
				this.originalName = name;
				this.actions = actions; //dictionary of action names and functions
				this.attributes = attributes;
				for (let i = 0; i < attributes.length; i++)
				{
					if (attributes[i] == "HasHealth")
					{
						this.health = new bodyHealthTracking;
					}
				}
			}
			
			function mapLocation(name, actions, travelLocations)
			{
				this.name = name;
				this.items = []; //array items in the location
				this.actions = actions; //dictionary of action names and functions
				this.travelLocations = travelLocations; //locations accessible from this locations
			}
			
			function damageHealthWithWeapon(weaponName, weaponType, target)
			{
				switch (weaponType)
				{
					case "Chopping":
						if (target.health.rightArm > 0)
						{
							target.health.rightArm = 0;
						}
						else if (target.health.leftArm > 0)
						{
							target.health.leftArm = 0;
						}
						else if (target.health.rightLeg > 0)
						{
							target.health.rightLeg = 0;
						}
						else if (target.health.leftLeg > 0)
						{
							target.health.leftLeg = 0;
						}
						else if (target.health.leftLeg > 0)
						{
							target.health.leftLeg = 0;
						}
						else if (target.health.head > 0)
						{
							target.health.head = 0;
						}
						break;
				}
				var statusText = target.health.getStatusText();
				if (statusText.length > 0)
				{
					target.name = target.health.getStatusText() + " " + target.originalName;
				}
			}
			
			function bodyHealthTracking()
			{
				this.head = 2;
				this.torso = 2;
				this.leftArm = 2;
				this.rightArm = 2;
				this.leftLeg = 2;
				this.rightLeg = 2;
				this.getStatusText = function()
				{
					var headStatus = "";
					var torsoStatus = "";
					var armStatus = "";
					var legStatus = "";
					if (this.head == 1)
					{
						headStatus = "Concussed";
					}
					else if (this.head == 0)
					{
						headStatus = "Decapitated";
					}
					
					if ((this.leftArm == 0) && (this.rightArm == 0))
					{
						armStatus = "Armless";
					}
					else if ((this.leftArm == 0) || (this.rightArm == 0))
					{
						armStatus = "One-armed";
					}
					
					if ((this.leftLeg == 0) && (this.rightLeg == 0))
					{
						legStatus = "Legless";
					}
					else if ((this.leftLeg == 0) || (this.rightLeg == 0))
					{
						legStatus = "One-Legged";
					}
					
					if (this.torso == 1)
					{
						torsoStatus = "Wounded";
					}
					
					var statusText = torsoStatus;
					if ((statusText.length > 0) && (headStatus.length > 0))
					{
						statusText += ", ";
					}
					statusText += headStatus;
					if ((statusText.length > 0) && (armStatus.length > 0))
					{
						statusText += ", ";
					}
					statusText += armStatus;
					if ((statusText.length > 0) && (legStatus.length > 0))
					{
						statusText += ", ";
					}
					statusText += legStatus;
					
					return statusText;
				};
			}
			
			var currentLocation;
			var inventory = []; //all the items that you're carrying
			var map = []; //all of the locations in the game
			var playerHealth = new bodyHealthTracking();
			
			function setUp()
			{
				inventory.push(new inventoryAxe());
				map = [forestClearing, forestPath];
				enterLocation("Forest Clearing");
			}
			
			function enterLocation(locationName)
			{
				inventory.sort((a, b) => (a.name > b.name) ? 1 : -1);
				map.sort((a, b) => (a.name > b.name) ? 1 : -1);
				
				$('#locationInfo').html(
					"Location: " + locationName
				);
				
				showMessage("You arrive at " + locationName + ".");
				
				for (let i = 0; i < map.length; i++)
				{
					if (map[i].name == locationName)
					{
						currentLocation = map[i];
						i = map.length;
					}
				}
				
				var nearbyLocationsList = "<ul>";
				for (let i = 0; i < currentLocation.travelLocations.length; i++)
				{
					var locationHTML = "<li class='clickableLI' onclick='enterLocation(\"" + currentLocation.travelLocations[i] + "\")'>" + currentLocation.travelLocations[i] + "</li>";
					nearbyLocationsList += locationHTML;
				}
				nearbyLocationsList += "</ul>";
				$('#nearbyLocations').html(nearbyLocationsList);
				
				$('#nearbyItems').html('');
				for (let i = 0; i < currentLocation.items.length; i++)
				{
					var item = currentLocation.items[i];
					$('#nearbyItems').html(
						$('#nearbyItems').html() + "<li>" + getItemHTML(item, "currentLocation.items", i)
					);
				}
				
				$('#inventoryInfo').html('');
				for (let i = 0; i < inventory.length; i++)
				{
					var item = inventory[i];
					$('#inventoryInfo').html(
						$('#inventoryInfo').html() + "<li>" + getItemHTML(item, "inventory", i)
					);
				}
				
				$('#healthStatusInfo').html(playerHealth.getStatusText());
			}
			
			function reloadLocation(message)
			{
				enterLocation(currentLocation.name);
				showMessage(message);
			}
			
			function getItemHTML(item, source, index)
			{
				var itemHTML = item.name;
				if (item.actions.length > 0)
				{
					var itemActionListHTML = getItemActionListHTML(item, source, index);
					itemHTML += itemActionListHTML;
				}
				return itemHTML;
			}
			
			function getItemActionListHTML(item, source, index)
			{
				var itemActionListHTML = "<ul>";
				for (let i = 0; i < item.actions.length; i++)
				{
					var action = item.actions[i];
					var actionName = action[0];
					var actionFunction = action[1];
					
					var actionHTML = "<li class='clickableLI' onclick='(" + source + "[" + index + "].actions[" + i + "][1].bind(" + source + "[" + index + "]))();'>" + actionName + "</li>";
					itemActionListHTML += actionHTML;
				}
				itemActionListHTML += "</ul>";
				return itemActionListHTML;
			}
			
			function showMessage(message)
			{
				$('#info').html(message);
			}
			
			//Items
			function inventoryAxe() {
				return new item(
					"Axe", 
					[
						["Drop", function() 
							{
								currentLocation.items.push(new nearbyAxe());
								inventory.splice(inventory.indexOf(this), 1);
								reloadLocation("You drop your axe.");
							}
						]
					], 
					["ChoppingTool", "Weapon-50-Chopping"] //WeaponRanks must be 2-digit numbers
				);
			};
			
			function woddenLog() {
				return new item(
					"Wooden Log", 
					[
						["Discard", function() 
							{
								inventory.splice(inventory.indexOf(this), 1);
								reloadLocation("You discard the wooden log.");
							}
						]
					], []
				);
			};
			
			function nearbyAxe() {
				return new item(
					"Axe",
					[
						["Pick up", function() 
							{
								currentLocation.items.splice(currentLocation.items.indexOf(this), 1);
								inventory.push(new inventoryAxe());
								reloadLocation("You pick up an axe.");
							}
						]
					], []
				);
			};
			
			function treeGoblin() { 
				return new item(
					"Tree Goblin",
					[
						["Attack", function()
							{
								var weapon = new getWeaponFromInventory(inventory);
								
								if (weapon.rank != -1)
								{
									damageHealthWithWeapon(weapon.name, weapon.type, this);
									if ((this.health.head == 0) || (this.health.torso == 0))
									{
										this.name = this.name + " (Dead)";
										this.actions = [];
									}
									reloadLocation("You attack the " + this.originalName + " with your " + weapon.name + ".");
								}
								else
								{
									showMessage("You need a weapon to attack the Tree Goblin.");
								}
							}
						]
					], ["HasHealth"]
				);
			};
			
			function tree() {
				return new item(
					"Tree",
					[
						["Chop Down", function() 
							{
								var hasChoppingTool = false;
								var choppingToolName = "";
								for (let i = 0; i < inventory.length; i++)
								{
									for (let j = 0; j < inventory[i].attributes.length; j++)
									{
										if (inventory[i].attributes[j] == "ChoppingTool")
										{
											hasChoppingTool = true;
											choppingToolName = inventory[i].name;
										}
									}
								}
								
								if (hasChoppingTool)
								{
									currentLocation.items.splice(currentLocation.items.indexOf(this), 1);
									inventory.push(new woddenLog());
									currentLocation.items.push(new treeGoblin());
									reloadLocation("You chop down a tree with your " + choppingToolName + ". A Tree Goblin emerges from the stump.");
								}
								else
								{
									showMessage("You need a tool to chop down a tree.");
								}
							}
						]
					], []
				);
			};
			
			//Locations
			var forestClearing = new mapLocation(
				"Forest Clearing",
				[], //actions
				["Forest Path"] //locations
			);
			forestClearing.items.push(new tree());
			forestClearing.items.push(new tree());
			forestClearing.items.push(new tree());
			
			var forestPath = new mapLocation(
				"Forest Path",
				[], //actions
				["Forest Clearing"] //locations
			);
			
		</script>
	</body>
</html>
